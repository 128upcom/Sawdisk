{% extends "base.html" %}

{% block title %}Scan Summary - SawDisk{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="h2 mb-4">
            <i class="fas fa-chart-bar text-success"></i> 
            Scan Summary
        </h1>
    </div>
</div>

<!-- Scan Overview Cards -->
<div class="row mb-4" id="overview-cards">
    <!-- Cards will be populated by JavaScript -->
</div>

<!-- Detailed Statistics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle text-primary"></i> Scan Information
                </h5>
            </div>
            <div class="card-body">
                <div id="scan-info">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading scan summary...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie text-info"></i> File Type Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="file-distribution">
                    <div class="text-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search text-success"></i> Crypto Items Found
                </h5>
            </div>
            <div class="card-body">
                <div id="crypto-results">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-ul text-warning"></i> Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <div id="performance-metrics">
                    <div class="text-center">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Extra Statistics -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table text-secondary"></i> Detailed Statistics
                </h5>
            </div>
            <div class="card-body">
                <div id="detailed-stats">
                    <div class="text-center">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function loadScanSummary() {
    fetch('/api/scan/summary')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            displayScanSummary(data);
        })
        .catch(error => {
            console.error('Error loading scan summary:', error);
            showError('Failed to load scan summary');
        });
}

function displayScanSummary(summary) {
    displayOverviewCards(summary);
    displayScanInfo(summary);
    displayFileDistribution(summary);
    displayCryptoResults(summary);
    displayPerformanceMetrics(summary);
    displayDetailedStats(summary);
}

function displayOverviewCards(summary) {
    const summary_stats = summary.scan_summary;
    const container = document.getElementById('overview-cards');
    
    container.innerHTML = `
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">FILES FOUND</h6>
                            <h2 class="mb-0">${summary_stats.total_files_found.toLocaleString()}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-files fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">DIRECTORIES</h6>
                            <h2 class="mb-0">${summary_stats.total_directories_scanned.toLocaleString()}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-folder fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">CRYPTO ITEMS</h6>
                            <h2 class="mb-0">${summary_stats.crypto_items_found}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-coins fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">TOTAL SIZE</h6>
                            <h2 class="mb-0">${summary_stats.total_bytes_scanned_readable}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayScanInfo(summary) {
    const container = document.getElementById('scan-info');
    const summary_stats = summary.scan_summary;
    
    container.innerHTML = `
        <div class="mb-3">
            <strong>Scan Path:</strong><br>
            <code>${summary.scan_path}</code>
        </div>
        
        <div class="mb-3">
            <strong>Scan Duration:</strong><br>
            ${formatDuration(summary.scan_duration)}
        </div>
        
        <div class="mb-3">
            <strong>Files Analyzed:</strong><br>
            ${summary_stats.files_analyzed.toLocaleString()} of ${summary_stats.total_files_found.toLocaleString()}
        </div>
        
        <div class="mb-3">
            <strong>Scan Configuration:</strong><br>
            Max Depth: ${summary_stats.max_depth_configured} | Threads: ${summary_stats.threads_used}
        </div>
        
        <div class="mb-3">
            <strong>Scan Depth Reached:</strong><br>
            ${summary_stats.scan_depth_reached} levels deep
        </div>
        
        <div class="mb-3">
            <strong>Crypto Extensions Found:</strong><br>
            ${summary_stats.crypto_extensions_found} files with crypto-related extensions
        </div>
    `;
}

function displayFileDistribution(summary) {
    const container = document.getElementById('file-distribution');
    const fileTypes = summary.file_statistics.top_10_file_types;
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Extension</th><th>Count</th><th>Total Size</th></tr></thead><tbody>';
    
    fileTypes.forEach(type => {
        html += `
            <tr>
                <td><code>${type.extension}</code></td>
                <td>${type.count.toLocaleString()}</td>
                <td>${convertBytes(type.total_bytes)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    html += `<small class="text-muted">Top ${fileTypes.length} file types. Total unique extensions: ${summary.file_statistics.unique_extensions_found}</small>`;
    
    container.innerHTML = html;
}

function displayCryptoResults(summary) {
    const container = document.getElementById('crypto-results');
    const results = summary.scan_results;
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-shield-alt fa-3x"></i>
                <p class="mt-2">No crypto-related items found</p>
                <small>This could mean:
                    <ul class="list-unstyled mt-2">
                        <li>• The drive is clean</li>
                        <li>• Files are encrypted</li>
                        <li>• Files are in unmonitored areas</li>
                    </ul>
                </small>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Type</th><th>Confidence</th><th>Size</th><th>Path</th></tr></thead><tbody>';
    
    results.forEach(item => {
        const confidenceClass = item.confidence >= 0.7 ? 'text-success' : 
                              item.confidence >= 0.5 ? 'text-warning' : 'text-info';
        
        html += `
            <tr>
                <td><span class="badge bg-primary">${item.type}</span></td>
                <td><span class="${confidenceClass}">${(item.confidence * 100).toFixed(1)}%</span></td>
                <td>${item.size_readable}</td>
                <td><code class="small">${item.path.split('/').pop()}</code></td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    container.innerHTML = html;
}

function displayPerformanceMetrics(summary) {
    const container = document.getElementById('performance-metrics');
    const summary_stats = summary.scan_summary;
    
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-primary">${summary_stats.scan_speed_files_per_second.toFixed(1)}</h4>
                <small class="text-muted">files/second</small>
            </div>
            <div class="col-6">
                <h4 class="text-info">${summary_stats.scan_speed_mb_per_second.toFixed(1)}</h4>
                <small class="text-muted">MB/second</small>
            </div>
        </div>
        
        <hr>
        
        <div class="mt-3">
            <div class="mb-2">
                <strong>Largest File Found:</strong><br>
                <code>${summary.file_statistics.largest_file.path.split('/').pop()}</code><br>
                <small class="text-muted">${summary.file_statistics.largest_file.size_readable}</small>
            </div>
            
            <div class="mb-2">
                <strong>Analysis Efficiency:</strong><br>
                <span class="text-success">${(summary_stats.files_analyzed / summary_stats.total_files_found * 100).toFixed(1)}%</span> of files analyzed
            </div>
            
            <div class="mb-2">
                <strong>Crypto Hit Rate:</strong><br>
                <span class="text-warning">${(summary_stats.crypto_items_found / summary_stats.total_files_found * 100).toFixed(1)}%</span> crypto relevance
            </div>
        </div>
    `;
}

function displayDetailedStats(summary) {
    const container = document.getElementById('detailed-stats');
    const fileTypes = summary.file_statistics;
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-list"></i> File Type Breakdown</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Extension</th><th>Count</th><th>Size</th></tr>
                        </thead>
                        <tbody>
                            ${summary.file_statistics.top_10_file_types.map(type => `
                                <tr>
                                    <td><span class="badge bg-secondary">${type.extension}</span></td>
                                    <td>${type.count.toLocaleString()}</td>
                                    <td>${convertBytes(type.total_bytes)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="col-md-6">
                <h6><i class="fas fa-info-circle"></i> Technical Details</h6>
                <ul class="list-unstyled">
                    <li><strong>Scan Path:</strong> <code>${summary.scan_path}</code></li>
                    <li><strong>Start Time:</strong> ${new Date().toLocaleString()}</li>
                    <li><strong>Duration:</strong> ${formatDuration(summary.scan_duration)}</li>
                    <li><strong>Threads Used:</strong> ${summary.scan_summary.threads_used}</li>
                    <li><strong>Max Depth:</strong> ${summary.scan_summary.max_depth_configured}</li>
                    <li><strong>Depth Reached:</strong> ${summary.scan_summary.scan_depth_reached}</li>
                    <li><strong>Unique Extensions:</strong> ${fileTypes.unique_extensions_found}</li>
                    <li><strong>Crypto Extensions:</strong> ${fileTypes.crypto_related_files}</li>
                </ul>
            </div>
        </div>
    `;
}

function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

function convertBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showError(message) {
    document.getElementById('scan-info').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadScanSummary();
});
</script>
{% endblock %}
