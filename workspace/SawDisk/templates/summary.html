{% extends "base.html" %}

{% block title %}Scan Summary - SawDisk{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1 class="h2 mb-4">
            <i class="fas fa-chart-bar text-success"></i> 
            Scan Summary
        </h1>
    </div>
    <div class="col-md-4">
        <div class="mb-4">
            <label for="scan-select" class="form-label">
                <i class="fas fa-history"></i> Select Scan:
            </label>
            <select id="scan-select" class="form-select" onchange="loadScanSummary(this.value)">
                <option value="">Loading scans...</option>
            </select>
        </div>
    </div>
</div>

<!-- Scan Overview Cards -->
<div class="row mb-4" id="overview-cards">
    <!-- Cards will be populated by JavaScript -->
</div>

<!-- Detailed Statistics -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle text-primary"></i> Scan Information
                </h5>
            </div>
            <div class="card-body">
                <div id="scan-info">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading scan summary...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie text-info"></i> File Type Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="file-distribution">
                    <div class="text-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search text-success"></i> Crypto Items Found
                </h5>
            </div>
            <div class="card-body">
                <div id="crypto-results">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-ul text-warning"></i> Performance Metrics
                </h5>
            </div>
            <div class="card-body">
                <div id="performance-metrics">
                    <div class="text-center">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Extra Statistics -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table text-secondary"></i> Detailed Statistics
                </h5>
            </div>
            <div class="card-body">
                <div id="detailed-stats">
                    <div class="text-center">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let currentScanId = null;

function loadScanHistory() {
    console.log('Loading scan history...');
    fetch('/api/scan/history')
        .then(response => {
            console.log('History response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Scan history loaded:', data);
            if (data.error) {
                console.error('Error loading scan history:', data.error);
                showError('Failed to load scan history: ' + data.error);
                return;
            }
            
            const select = document.getElementById('scan-select');
            if (!select) {
                console.error('Scan select element not found');
                showError('Page structure error: scan selector not found');
                return;
            }
            
            select.innerHTML = '<option value="">Latest Scan (Current Session)</option>';
            
            if (data.scans && data.scans.length > 0) {
                console.log(`Found ${data.scans.length} scans`);
                data.scans.forEach(scan => {
                    const option = document.createElement('option');
                    option.value = scan.scan_id;
                    const date = new Date(scan.timestamp);
                    const dateStr = date.toLocaleString();
                    option.textContent = `${scan.drive_name} - ${dateStr} (${scan.files_found} items)`;
                    select.appendChild(option);
                });
                
                // Load latest scan by default
                currentScanId = data.scans[0].scan_id;
                select.value = currentScanId;
                console.log('Loading summary for scan:', currentScanId);
                loadScanSummary(currentScanId);
            } else {
                console.log('No scans in history, trying current session');
                // No scans in history, try to load current session
                loadScanSummary(null);
            }
        })
        .catch(error => {
            console.error('Error loading scan history:', error);
            showError('Failed to load scan history: ' + error.message + '. Trying current session...');
            loadScanSummary(null);
        });
}

function loadScanSummary(scanId) {
    currentScanId = scanId;
    const url = scanId ? `/api/scan/summary?scan_id=${scanId}` : '/api/scan/summary';
    console.log('Loading scan summary from:', url);
    
    // Show loading state
    const scanInfo = document.getElementById('scan-info');
    if (scanInfo) {
        scanInfo.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading scan summary...</p>
            </div>
        `;
    }
    
    fetch(url)
        .then(response => {
            console.log('Summary response status:', response.status);
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to load summary');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Summary data received:', data);
            if (data.error) {
                console.error('Summary error:', data.error);
                showError(data.error);
                return;
            }
            
            console.log('Displaying summary...');
            displayScanSummary(data);
        })
        .catch(error => {
            console.error('Error loading scan summary:', error);
            showError('Failed to load scan summary: ' + error.message);
        });
}

function displayScanSummary(summary) {
    // Update page title with scan info if available
    if (summary.scan_id) {
        const date = summary.timestamp ? new Date(summary.timestamp).toLocaleString() : '';
        document.title = `Scan Summary - ${summary.scan_id}${date ? ' (' + date + ')' : ''} - SawDisk`;
    }
    
    try {
        displayOverviewCards(summary);
        displayScanInfo(summary);
        displayFileDistribution(summary);
        displayCryptoResults(summary);
        displayPerformanceMetrics(summary);
        displayDetailedStats(summary);
    } catch (error) {
        console.error('Error displaying scan summary:', error);
        showError('Error displaying summary: ' + error.message);
    }
}

function displayOverviewCards(summary) {
    if (!summary || !summary.scan_summary) {
        console.error('Invalid summary data:', summary);
        return;
    }
    
    const summary_stats = summary.scan_summary;
    const container = document.getElementById('overview-cards');
    
    if (!container) {
        console.error('Overview cards container not found');
        return;
    }
    
    container.innerHTML = `
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">FILES FOUND</h6>
                            <h2 class="mb-0">${summary_stats.total_files_found.toLocaleString()}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-files fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">DIRECTORIES</h6>
                            <h2 class="mb-0">${summary_stats.total_directories_scanned.toLocaleString()}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-folder fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">CRYPTO ITEMS</h6>
                            <h2 class="mb-0">${summary_stats.crypto_items_found}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-coins fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">TOTAL SIZE</h6>
                            <h2 class="mb-0">${summary_stats.total_bytes_scanned_readable}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function displayScanInfo(summary) {
    if (!summary || !summary.scan_summary) {
        console.error('Invalid summary data for scan info:', summary);
        return;
    }
    
    const container = document.getElementById('scan-info');
    if (!container) {
        console.error('Scan info container not found');
        return;
    }
    
    const summary_stats = summary.scan_summary;
    
    container.innerHTML = `
        <div class="mb-3">
            <strong>Scan Path:</strong><br>
            <code>${summary.scan_path}</code>
        </div>
        
        <div class="mb-3">
            <strong>Scan Duration:</strong><br>
            ${formatDuration(summary.scan_duration)}
        </div>
        
        <div class="mb-3">
            <strong>Files Analyzed:</strong><br>
            ${summary_stats.files_analyzed.toLocaleString()} of ${summary_stats.total_files_found.toLocaleString()}
        </div>
        
        <div class="mb-3">
            <strong>Scan Configuration:</strong><br>
            Max Depth: ${summary_stats.max_depth_configured} | Threads: ${summary_stats.threads_used}
        </div>
        
        <div class="mb-3">
            <strong>Scan Depth Reached:</strong><br>
            ${summary_stats.scan_depth_reached} levels deep
        </div>
        
        <div class="mb-3">
            <strong>Crypto Extensions Found:</strong><br>
            ${summary_stats.crypto_extensions_found} files with crypto-related extensions
        </div>
    `;
}

function displayFileDistribution(summary) {
    if (!summary || !summary.file_statistics) {
        console.error('Invalid summary data for file distribution:', summary);
        return;
    }
    
    const container = document.getElementById('file-distribution');
    if (!container) {
        console.error('File distribution container not found');
        return;
    }
    
    const fileTypes = summary.file_statistics.top_10_file_types || [];
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Extension</th><th>Count</th><th>Total Size</th></tr></thead><tbody>';
    
    fileTypes.forEach(type => {
        html += `
            <tr>
                <td><code>${type.extension}</code></td>
                <td>${type.count.toLocaleString()}</td>
                <td>${convertBytes(type.total_bytes)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    html += `<small class="text-muted">Top ${fileTypes.length} file types. Total unique extensions: ${summary.file_statistics.unique_extensions_found}</small>`;
    
    container.innerHTML = html;
}

function displayCryptoResults(summary) {
    const container = document.getElementById('crypto-results');
    const results = summary.scan_results;
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-shield-alt fa-3x"></i>
                <p class="mt-2">No crypto-related items found</p>
                <small>This could mean:
                    <ul class="list-unstyled mt-2">
                        <li>• The drive is clean</li>
                        <li>• Files are encrypted</li>
                        <li>• Files are in unmonitored areas</li>
                    </ul>
                </small>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Type</th><th>Confidence</th><th>Size</th><th>Path</th></tr></thead><tbody>';
    
    results.forEach(item => {
        const confidenceClass = item.confidence >= 0.7 ? 'text-success' : 
                              item.confidence >= 0.5 ? 'text-warning' : 'text-info';
        
        html += `
            <tr>
                <td><span class="badge bg-primary">${item.type}</span></td>
                <td><span class="${confidenceClass}">${(item.confidence * 100).toFixed(1)}%</span></td>
                <td>${item.size_readable}</td>
                <td><code class="small">${item.path.split('/').pop()}</code></td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    container.innerHTML = html;
}

function displayPerformanceMetrics(summary) {
    if (!summary || !summary.scan_summary) {
        console.error('Invalid summary data for performance metrics:', summary);
        return;
    }
    
    const container = document.getElementById('performance-metrics');
    if (!container) {
        console.error('Performance metrics container not found');
        return;
    }
    
    const summary_stats = summary.scan_summary;
    
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-6">
                <h4 class="text-primary">${summary_stats.scan_speed_files_per_second.toFixed(1)}</h4>
                <small class="text-muted">files/second</small>
            </div>
            <div class="col-6">
                <h4 class="text-info">${summary_stats.scan_speed_mb_per_second.toFixed(1)}</h4>
                <small class="text-muted">MB/second</small>
            </div>
        </div>
        
        <hr>
        
        <div class="mt-3">
            <div class="mb-2">
                <strong>Largest File Found:</strong><br>
                <code>${summary.file_statistics.largest_file.path.split('/').pop()}</code><br>
                <small class="text-muted">${summary.file_statistics.largest_file.size_readable}</small>
            </div>
            
            <div class="mb-2">
                <strong>Analysis Efficiency:</strong><br>
                <span class="text-success">${(summary_stats.files_analyzed / summary_stats.total_files_found * 100).toFixed(1)}%</span> of files analyzed
            </div>
            
            <div class="mb-2">
                <strong>Crypto Hit Rate:</strong><br>
                <span class="text-warning">${(summary_stats.crypto_items_found / summary_stats.total_files_found * 100).toFixed(1)}%</span> crypto relevance
            </div>
        </div>
    `;
}

function displayDetailedStats(summary) {
    if (!summary || !summary.file_statistics) {
        console.error('Invalid summary data for detailed stats:', summary);
        return;
    }
    
    const container = document.getElementById('detailed-stats');
    if (!container) {
        console.error('Detailed stats container not found');
        return;
    }
    
    const fileTypes = summary.file_statistics;
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-list"></i> File Type Breakdown</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Extension</th><th>Count</th><th>Size</th></tr>
                        </thead>
                        <tbody>
                            ${summary.file_statistics.top_10_file_types.map(type => `
                                <tr>
                                    <td><span class="badge bg-secondary">${type.extension}</span></td>
                                    <td>${type.count.toLocaleString()}</td>
                                    <td>${convertBytes(type.total_bytes)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="col-md-6">
                <h6><i class="fas fa-info-circle"></i> Technical Details</h6>
                <ul class="list-unstyled">
                    <li><strong>Scan Path:</strong> <code>${summary.scan_path}</code></li>
                    <li><strong>Start Time:</strong> ${new Date().toLocaleString()}</li>
                    <li><strong>Duration:</strong> ${formatDuration(summary.scan_duration)}</li>
                    <li><strong>Threads Used:</strong> ${summary.scan_summary.threads_used}</li>
                    <li><strong>Max Depth:</strong> ${summary.scan_summary.max_depth_configured}</li>
                    <li><strong>Depth Reached:</strong> ${summary.scan_summary.scan_depth_reached}</li>
                    <li><strong>Unique Extensions:</strong> ${fileTypes.unique_extensions_found}</li>
                    <li><strong>Crypto Extensions:</strong> ${fileTypes.crypto_related_files}</li>
                </ul>
            </div>
        </div>
    `;
}

function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

function convertBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showError(message) {
    console.error('Showing error:', message);
    const scanInfo = document.getElementById('scan-info');
    if (scanInfo) {
        scanInfo.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${message}
            </div>
        `;
    }
    
    // Also show in overview cards area
    const overviewCards = document.getElementById('overview-cards');
    if (overviewCards) {
        overviewCards.innerHTML = `
            <div class="col-md-12">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> ${message}
                </div>
            </div>
        `;
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Summary page loaded, initializing...');
    try {
        loadScanHistory();
    } catch (error) {
        console.error('Error initializing summary page:', error);
        showError('Failed to initialize page: ' + error.message);
    }
});
</script>
{% endblock %}
